--[[
--æ— éšœç¢ç‰ˆä¸“ç”¨è„šæœ¬
--è„šæœ¬åç§°: å¤©æ°”
--ç”¨é€”ï¼šè”ç½‘æŸ¥æ‰¾å¤©æ°”ç›¸å…³ä¿¡æ¯
--ç‰ˆæœ¬å·: 2.0
â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚
æ—¥æœŸ: 2020å¹´08æœˆ13æ—¥ğŸ—“ï¸
å†œå†: é¼ ğŸåºšå­å¹´å…­æœˆå»¿å››
æ—¶é—´: 11:28:34ğŸ•š
æ˜ŸæœŸ: å‘¨å››
--åˆ¶ä½œè€…: é£ä¹‹æ¼«èˆ
--é¦–å‘qqç¾¤: åŒæ–‡å ‚(480159874)
--é‚®ç®±: bj19490007@163.com(ä¸ä¸€å®šåŠæ—¶çœ‹åˆ°)

--é…ç½®è¯´æ˜
ç”¨æ³•ä¸€
ç¬¬â‘ æ­¥ å°† è„šæœ¬æ–‡ä»¶æ”¾ç½® Android/rime/script æ–‡ä»¶å¤¹å†…,

ç¬¬â‘¡æ­¥ å‘ä¸»é¢˜æ–¹æ¡ˆä¸­åŠ å…¥æŒ‰é”®
ä»¥ XXX.trime.yamlä¸»é¢˜æ–¹æ¡ˆä¸ºä¾‹
æ‰¾åˆ°ä»¥ä¸‹èŠ‚ç‚¹preset_keysï¼ŒåŠ å…¥ä»¥ä¸‹æŒ‰é”®LuaTQ1ï¼ŒLuaTQ2

preset_keys:
  LuaTQ1: {label: å½“å‰å¤©æ°”, send: function, command: 'å¤©æ°”.lua', option: "ã€Šã€Šå‘½ä»¤è¡Œ&&æŸ¥å½“å‰å€™é€‰ã€‹ã€‹"}#æ ¹æ®å½“å‰å€™é€‰æŸ¥æ‰¾å¯¹åº”åŸå¸‚å¤©æ°”ä¿¡æ¯
  LuaTQ1: {label: å½“å‰å¤©æ°”, send: function, command: 'å¤©æ°”.lua', option: "ã€Šã€Šå‘½ä»¤è¡Œã€‹ã€‹ã€ã€åŸå¸‚åç§°ã€‘ã€‘"}#åŸå¸‚åç§°ä¸ºè‡ªå®šä¹‰é¡¹,å¯æ›¿æ¢ä¸º æ­¦æ±‰,åŒ—äº¬,å¹¿å·ç­‰å¸¸ç”¨åŸå¸‚å
  
å‘è¯¥ä¸»é¢˜æ–¹æ¡ˆä»»æ„é”®ç›˜æŒ‰é”®ä¸­åŠ å…¥ä¸Šè¿°æŒ‰é”®æ—¢å¯
--------------------
ç”¨æ³•äºŒ
â‘ æ”¾åˆ°è„šæœ¬å¯åŠ¨å™¨->è„šæœ¬åº“ç›®å½• ä¸‹ä»»æ„ä½ç½®åŠå­æ–‡ä»¶å¤¹è¶³ä¸­,è„šæœ¬å¯åŠ¨å™¨è‡ªåŠ¨æ˜¾ç¤ºè¯¥è„šæœ¬
â‘¡ä¸»é¢˜æ–¹æ¡ˆæŒ‚è½½è„šæœ¬å¯åŠ¨å™¨
â‘¢æ˜¾ç¤ºä¸€ä¸ªé”®ç›˜ç•Œé¢,ç‚¹å‡»æŒ‰é”®å³å¯
]]




require "import"
import "java.io.File"
import "android.os.*"

import "android.widget.*"
import "android.view.*"
import "android.content.Context"
import "cjson"
import "com.osfans.trime.*" --è½½å…¥åŒ…

import "script.åŒ….å…¶å®ƒ.ä¸»é”®ç›˜"





--è‡ªå®šä¹‰é¢œè‰²é”®ç›˜(é”®ç›˜åç§°,å•ä¸ªé”®ç›˜çŸ­è¯­æ•°,é»˜è®¤å®½åº¦,é»˜è®¤é«˜åº¦,æŒ‰é”®ç»„,å‚æ•°,è„šæœ¬ç›¸å¯¹è·¯å¾„,æ•°æ®æ–‡ä»¶)
function è‡ªå®šä¹‰é¢œè‰²çŸ­è¯­é”®ç›˜(é”®ç›˜åç§°,å•ä¸ªé”®ç›˜çŸ­è¯­æ•°,é»˜è®¤å®½åº¦,é»˜è®¤é«˜åº¦,å‚æ•°,è„šæœ¬ç›¸å¯¹è·¯å¾„,æ•°æ®æ–‡ä»¶)

import "android.content.pm.PackageManager"
local ç‰ˆæœ¬å· = service.getPackageManager().getPackageInfo(service.getPackageName(), 0).versionName
local ç‰ˆæœ¬å·1=tonumber(string.sub(ç‰ˆæœ¬å·,-8))

if ç‰ˆæœ¬å·1<20200526 then
 print("è¯´æ˜: ä¸­æ–‡è¾“å…¥æ³•ç‰ˆæœ¬å·ä½äº20200526,è¯·å‡çº§åˆ°ä»¥ä¸Šç‰ˆæœ¬,å¦åˆ™æ— æ³•è¿è¡Œè¯¥è„šæœ¬")
 return
end

local ç¼–å·=1
local çŸ­è¯­ç»„1={}
local æŒ‰é”®ç»„={}




if å‚æ•°=="ã€Šã€Šç¼–è¾‘æ•°æ®ã€‹ã€‹" then
 service.editFile(æ•°æ®æ–‡ä»¶) 
 return
end


if File(æ•°æ®æ–‡ä»¶).exists()==false then
 io.open(æ•°æ®æ–‡ä»¶,"w"):write("æ— æ•°æ®,è¯·ç¼–è¾‘æ–‡ä»¶"):close()
end


for c in io.lines(æ•°æ®æ–‡ä»¶) do
 if c!="" && string.sub(c,1,2)!="##" then
  c=c:gsub("<br>","\n")
  c=c:gsub("\\#","#")
  çŸ­è¯­ç»„1[#çŸ­è¯­ç»„1+1]=c 
 end
end--for



if å‚æ•°=="ã€Šã€Šè¿”å›é¦–é¡µã€‹ã€‹" || å‚æ•°=="ã€Šã€Šå¯¼å‡ºæ•°æ®_å–æ¶ˆã€‹ã€‹" || å‚æ•°=="ã€Šã€Šå¯¼å…¥æ•°æ®_å–æ¶ˆã€‹ã€‹" then  ç¼–å·=1 end


--è·³è½¬ä½ç½®
if string.find(å‚æ•°,"<<")!=nil && string.find(å‚æ•°,">>")!=nil then
 ç¼–å·=tonumber(string.sub(å‚æ•°,string.find(å‚æ•°,"<<")+2,string.find(å‚æ•°,">>")-1))
 --print(ç¼–å·)
end



local æ€»åºå·=math.ceil(#çŸ­è¯­ç»„1/å•ä¸ªé”®ç›˜çŸ­è¯­æ•°)
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=100
 æŒ‰é”®["height"]=25
 æŒ‰é”®["click"]=""
 --æŒ‰é”®["click"]={label=çŸ­è¯­ç»„1[i],commit=çŸ­è¯­ç»„1[i]}
 æŒ‰é”®["label"]=é”®ç›˜åç§°.."("..ç¼–å·.."/"..æ€»åºå·..")"
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®


--ä¸Šå±æ•°æ®
if string.find(å‚æ•°,"ã€ã€")!=nil && string.find(å‚æ•°,"ã€‘ã€‘")!=nil then
 local ä½ç½®=tonumber(string.sub(å‚æ•°,string.find(å‚æ•°,"ã€ã€")+6,string.find(å‚æ•°,"ã€‘ã€‘")-1))
 service.commitText(çŸ­è¯­ç»„1[ä½ç½®])
 
end


if ç¼–å·==1 then
 if #çŸ­è¯­ç»„1<å•ä¸ªé”®ç›˜çŸ­è¯­æ•° then
  for i=1,#çŸ­è¯­ç»„1 do
    local æŒ‰é”®={}
    local ä½ç½®=i
    æŒ‰é”®["label"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®["click"]={label="â—€", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..ä½ç½®.."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®["key_back_color"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=é»˜è®¤å®½åº¦
  for i=1,å•ä¸ªé”®ç›˜çŸ­è¯­æ•°-#çŸ­è¯­ç»„1 do
   æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--for
  
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=33
  æŒ‰é”®["click"]={label="ç¼–è¾‘", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€Šã€Šç¼–è¾‘æ•°æ®ã€‹ã€‹"}
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=33
  æŒ‰é”®["click"]={label="âŒ«", repeatable="true", send= "BackSpace"}
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  local æŒ‰é”®=ä¸»é”®ç›˜()
  æŒ‰é”®["width"]=34
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 else
  
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®2
  for i=1,å•ä¸ªé”®ç›˜çŸ­è¯­æ•° do
   local å­ç¼–å·=i
   if #çŸ­è¯­ç»„1>å­ç¼–å·-1 then
    local æŒ‰é”®={}
    local ä½ç½®=å­ç¼–å·
    æŒ‰é”®["label"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®["click"]={label="â—€", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..ä½ç½®.."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®["key_back_color"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
   end--if
  end--for
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=25
 æŒ‰é”®["click"]={label="ç¼–è¾‘", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€Šã€Šç¼–è¾‘æ•°æ®ã€‹ã€‹"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=25
 æŒ‰é”®["click"]={label="ä¸‹ä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·+1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=25
  æŒ‰é”®["click"]={label="âŒ«", repeatable="true", send= "BackSpace"}
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®=ä¸»é”®ç›˜()
 æŒ‰é”®["width"]=25
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®


 end--if #çŸ­è¯­ç»„1<25
end--if ç¼–å·==1

if ç¼–å·>1 then
if #çŸ­è¯­ç»„1<ç¼–å·*å•ä¸ªé”®ç›˜çŸ­è¯­æ•° then
  for i=1,#çŸ­è¯­ç»„1-(ç¼–å·-1)*å•ä¸ªé”®ç›˜çŸ­è¯­æ•° do
    local æŒ‰é”®={}
    local ä½ç½®=i+(ç¼–å·-1)*å•ä¸ªé”®ç›˜çŸ­è¯­æ•°
    æŒ‰é”®["label"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®["click"]={label="â—€", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..ä½ç½®.."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®["key_back_color"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--for
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=é»˜è®¤å®½åº¦
  for i=1,å•ä¸ªé”®ç›˜çŸ­è¯­æ•°*ç¼–å·-#çŸ­è¯­ç»„1 do
   æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--for
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=33
  æŒ‰é”®["click"]={label="ä¸Šä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·-1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®={}
  æŒ‰é”®["width"]=33
  æŒ‰é”®["click"]={label="âŒ«", repeatable="true", send= "BackSpace"}
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®=ä¸»é”®ç›˜()
 æŒ‰é”®["width"]=34
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®

else
  for i=1,å•ä¸ªé”®ç›˜çŸ­è¯­æ•° do
   local å­ç¼–å·=i
   if #çŸ­è¯­ç»„1>å­ç¼–å·-1 then
    local æŒ‰é”®={}
    local ä½ç½®=å­ç¼–å·+(ç¼–å·-1)*å•ä¸ªé”®ç›˜çŸ­è¯­æ•°
    æŒ‰é”®["label"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®["click"]={label="â—€", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..ä½ç½®.."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®["key_back_color"]=çŸ­è¯­ç»„1[ä½ç½®]
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
   end--if
  end--for
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=25
 æŒ‰é”®["click"]={label="ä¸Šä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·-1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=25
 æŒ‰é”®["click"]={label="ä¸‹ä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·+1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®={}
  æŒ‰é”®["width"]=25
  æŒ‰é”®["click"]={label="âŒ«", repeatable="true", send= "BackSpace"}
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®=ä¸»é”®ç›˜()
 æŒ‰é”®["width"]=25
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
end--if #çŸ­è¯­ç»„1>ç¼–å·*22
end--if ç¼–å·>1 


 service.setKeyboard{
  name=é”®ç›˜åç§°,
  ascii_mode=0,
  width=é»˜è®¤å®½åº¦,
  height=é»˜è®¤é«˜åº¦,
  keys=æŒ‰é”®ç»„
  }

end--function è‡ªå®šä¹‰çŸ­è¯­é”®ç›˜



local å‚æ•°=(...)


local è„šæœ¬ç›®å½•=tostring(service.getLuaExtDir("script"))
local è„šæœ¬å=debug.getinfo(1,"S").source:sub(2)--è·å–Luaè„šæœ¬çš„å®Œæ•´è·¯å¾„

local è„šæœ¬ç›¸å¯¹è·¯å¾„=string.sub(è„šæœ¬å,#è„šæœ¬ç›®å½•+1)
local çº¯è„šæœ¬å=File(è„šæœ¬å).getName()
local æ•°æ®æ–‡ä»¶=string.sub(è„šæœ¬å,1,#è„šæœ¬å-4)..".txt"




local çŸ­è¯­æ•°=20--å•ä¸ªé”®ç›˜çš„çŸ­è¯­æ•°é‡
local é»˜è®¤å®½åº¦=25
local é»˜è®¤é«˜åº¦=32


 è‡ªå®šä¹‰é¢œè‰²çŸ­è¯­é”®ç›˜(string.sub(çº¯è„šæœ¬å,1,#çº¯è„šæœ¬å-4),çŸ­è¯­æ•°,é»˜è®¤å®½åº¦,é»˜è®¤é«˜åº¦,å‚æ•°,è„šæœ¬ç›¸å¯¹è·¯å¾„,æ•°æ®æ–‡ä»¶)




