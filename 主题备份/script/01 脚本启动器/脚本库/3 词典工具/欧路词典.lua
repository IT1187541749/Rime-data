--[[
--æ— éšœç¢ç‰ˆä¸“ç”¨è„šæœ¬
--ç”¨é€”ï¼šæ¬§è·¯è¯å…¸ï¼Œè‡ªåŠ¨æ‰“å¼€æ¬§è·¯è¯å…¸(è‹¥å­˜åœ¨)æŸ¥è¯ç•Œé¢ï¼ŒæŸ¥è¯¢æŒ‡å®šå†…å®¹

--ç‰ˆæœ¬å·: 2.0
--åˆ¶ä½œæ—¥æœŸ
â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚
æ—¥æœŸ: 2020å¹´03æœˆ25æ—¥ğŸ—“ï¸
å†œå†: é¼ (åºšå­)å¹´ä¸‰æœˆåˆäºŒ
æ—¶é—´: 22:53:50ğŸ•¥
æ˜ŸæœŸ: å‘¨ä¸‰
--åˆ¶ä½œè€…: é£ä¹‹æ¼«èˆ
--é¦–å‘qqç¾¤: åŒæ–‡å ‚(480159874)
--é‚®ç®±: bj19490007@163.com(ä¸ä¸€å®šåŠæ—¶çœ‹åˆ°)
--å¦‚ä½•å®‰è£…å¹¶ä½¿ç”¨: è¯·å‚è€ƒç¾¤æ–‡ä»¶ï¼Œè·¯å¾„[åŒæ–‡æ— éšœç¢LUAè„šæœ¬]->åŒæ–‡æ— éšœç¢ç‰ˆluaè„šæœ¬ä½¿ç”¨è¯´æ˜.pdf

--é…ç½®è¯´æ˜
ç¬¬â‘ æ­¥ å°† è¯å…¸.lua æ–‡ä»¶æ”¾ç½® rime/script æ–‡ä»¶å¤¹å†…


]]

require "import"
import "android.widget.*"
import "android.view.*"
import "java.io.*"
import "android.content.*" 

import "script.åŒ….å…¶å®ƒ.ä¸»é”®ç›˜"
import "script.åŒ….å…¶å®ƒ.é¦–æ¬¡å¯åŠ¨æç¤º"


local function åˆ†äº«æ–‡å­—åˆ°æ¬§è·¯(å¯¼å…¥å†…å®¹)
 --åˆ†äº«æ–‡å­—åˆ°æ¬§è·¯
 text=å¯¼å…¥å†…å®¹
 intent=Intent(Intent.ACTION_SEND); 
 intent.setType("text/plain"); 
 intent.putExtra(Intent.EXTRA_SUBJECT, "åˆ†äº«"); 
 intent.putExtra(Intent.EXTRA_TEXT, text); 
 intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK); 
 --é‡ç‚¹ï¼ŒæŒ‡å®šåŒ…åå’Œåˆ†äº«ç•Œé¢
 componentName =ComponentName("com.eusoft.eudic","com.eusoft.dict.activity.dict.LightpeekActivity");
 intent.setComponent(componentName)
 
 service.startActivity(Intent.createChooser(intent,"åˆ†äº«åˆ°:")); 

end--function åˆ†äº«æ–‡å­—åˆ°æ¬§è·¯

--å¤§å†™å­—æ¯å‰é¢åŠ ç©ºæ ¼
local function å¤§å†™å­—æ¯å‰åŠ ç©ºæ ¼(å†…å®¹)
 å¤§å†™å­—æ¯="ABCDEFGHIJKLMNOPQRSTUVWXYZ"
 for i=1,#å¤§å†™å­—æ¯ do
  å†…å®¹=å†…å®¹:gsub(å¤§å†™å­—æ¯:sub(i,i)," "..å¤§å†™å­—æ¯:sub(i,i))
  
  
 end
 
 return å†…å®¹
end--function å¤§å†™åŠ ç©ºæ ¼(å†…å®¹)


local å‚æ•° = (...)
local ç¼–å·=1

local è„šæœ¬ç›®å½•=tostring(service.getLuaExtDir("script"))
local è„šæœ¬è·¯å¾„=debug.getinfo(1,"S").source:sub(2)--è·å–Luaè„šæœ¬çš„å®Œæ•´è·¯å¾„
local è„šæœ¬å=File(è„šæœ¬è·¯å¾„).getName()
local çº¯è„šæœ¬å=è„šæœ¬å:sub(1,-5)
local è„šæœ¬ç›¸å¯¹è·¯å¾„=string.sub(è„šæœ¬è·¯å¾„,#è„šæœ¬ç›®å½•+1)
local é…ç½®æ–‡ä»¶=è„šæœ¬ç›®å½•.."/è„šæœ¬é…ç½®_å‹¿åˆ .txt"


local æç¤ºå†…å®¹=[[
è¯´æ˜:æœ¬è„šæœ¬éœ€é…åˆæ¬§è·¯è¯å…¸app
å°†è‡ªåŠ¨æ‰“å¼€æ¬§è·¯è¯å…¸(è‹¥å­˜åœ¨)æŸ¥è¯ç•Œé¢ï¼ŒæŸ¥è¯¢æŒ‡å®šå†…å®¹
è‹¥å­˜åœ¨å¤šä¸ªå€™é€‰,ç‚¹å‡»å†…å®¹åè‡ªåŠ¨è¿›è¡ŒæŸ¥è¯¢
]]
é¦–æ¬¡å¯åŠ¨æç¤º(è„šæœ¬å,æç¤ºå†…å®¹)


--è·³è½¬ä½ç½®
if string.find(å‚æ•°,"<<")!=nil && string.find(å‚æ•°,">>")!=nil then
 ç¼–å·=tonumber(string.sub(å‚æ•°,string.find(å‚æ•°,"<<")+2,string.find(å‚æ•°,">>")-1))
 --print(ç¼–å·)
end
--æ‹†åˆ†ä¸Šå±æ•°æ®
if string.find(å‚æ•°,"ã€ã€")!=nil && string.find(å‚æ•°,"ã€‘ã€‘")!=nil then
 local å†…å®¹=string.sub(å‚æ•°,string.find(å‚æ•°,"ã€ã€")+6,string.find(å‚æ•°,"ã€‘ã€‘")-1)
 åˆ†äº«æ–‡å­—åˆ°æ¬§è·¯(å†…å®¹)
 return
end


local å·²å¯ç”¨=false
local å®šåˆ¶å®½åº¦=é»˜è®¤å®½åº¦
if File(é…ç½®æ–‡ä»¶).exists() then--é…ç½®æ–‡ä»¶å­˜åœ¨
  for c in io.lines(é…ç½®æ–‡ä»¶) do--æŒ‰è¡Œè¯»å–æ–‡ä»¶,æ£€æµ‹è„šæœ¬æ˜¯å¦å·±å¯ç”¨
   if c=="æµ‹è¯•åŠŸèƒ½=å·²å¯ç”¨" then
    å·²å¯ç”¨=true
    å®šåˆ¶å®½åº¦=25
   end
  end--for
end--if é…ç½®æ–‡ä»¶

import "com.osfans.trime.*" --è½½å…¥åŒ…
local å€™é€‰ç»„=Rime.getCandidates()
local ç¼–ç =Rime.RimeGetInput() --ç•¶å‰ç·¨ç¢¼

local æ˜¾ç¤ºå†…å®¹ç»„={}
local æç¤ºå†…å®¹ç»„={}

import "android.content.Context"  --å¯¼å…¥ç±»
local å‰ªè´´æ¿=tostring(service.getSystemService(Context.CLIPBOARD_SERVICE).getText()) --è·å–å‰ªè´´æ¿ 
æ˜¾ç¤ºå†…å®¹ç»„[#æ˜¾ç¤ºå†…å®¹ç»„+1]=å‰ªè´´æ¿
æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„+1]="å‰ªè´´æ¿"

if ç¼–ç ==nil || ç¼–ç =="" then
 åˆ†äº«æ–‡å­—åˆ°æ¬§è·¯(å‰ªè´´æ¿)
 print("æ— å€™é€‰,è‡ªåŠ¨æŸ¥è¯¢å‰ªåˆ‡æ¿å†…å®¹")
 return 
end




if string.find(ç¼–ç ,"\'")!=nil then
  local å¥å­=string.gsub(ç¼–ç ,"\'"," ")  
  æ˜¾ç¤ºå†…å®¹ç»„[#æ˜¾ç¤ºå†…å®¹ç»„+1]=å¥å­
  æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„+1]="å¥å­"
else
 æ˜¾ç¤ºå†…å®¹ç»„[#æ˜¾ç¤ºå†…å®¹ç»„+1]=ç¼–ç 
 æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„+1]="ç¼–ç "
 æ˜¾ç¤ºå†…å®¹ç»„[#æ˜¾ç¤ºå†…å®¹ç»„+1]=string.upper(string.sub(ç¼–ç ,1,1))..string.sub(ç¼–ç ,2,#ç¼–ç )
 æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„+1]="é¦–å¤§å†™"
 æ˜¾ç¤ºå†…å®¹ç»„[#æ˜¾ç¤ºå†…å®¹ç»„+1]=string.upper(ç¼–ç )
 æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„+1]="å¤§å†™"
end--if



if #å€™é€‰ç»„>0 then
 for i=1,#å€™é€‰ç»„ do
  æ˜¾ç¤ºå†…å®¹ç»„[#æ˜¾ç¤ºå†…å®¹ç»„+1]=tostring(å€™é€‰ç»„[i-1].text)
  æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„+1]=tostring(å€™é€‰ç»„[i-1].comment)
  if å€™é€‰ç»„[i-1].comment==nil then æç¤ºå†…å®¹ç»„[#æç¤ºå†…å®¹ç»„]="" end
 end--for
end--if



--å®šä¹‰é”®ç›˜
--------------------
local çŸ­è¯­æ•°=25--å•ä¸ªé”®ç›˜çš„çŸ­è¯­æ•°é‡
local é»˜è®¤å®½åº¦=20
local é»˜è®¤é«˜åº¦=32

import "android.content.pm.PackageManager"
local ç‰ˆæœ¬å· = service.getPackageManager().getPackageInfo(service.getPackageName(), 0).versionName
local ç‰ˆæœ¬å·1=tonumber(string.sub(ç‰ˆæœ¬å·,-8))

if ç‰ˆæœ¬å·1<20200526 then
 print("è¯´æ˜: ä¸­æ–‡è¾“å…¥æ³•ç‰ˆæœ¬å·ä½äº20200526,è¯·å‡çº§åˆ°ä»¥ä¸Šç‰ˆæœ¬,å¦åˆ™æ— æ³•è¿è¡Œè¯¥è„šæœ¬")
 return
end


local æŒ‰é”®ç»„={}

local æ€»åºå·=math.ceil(#æ˜¾ç¤ºå†…å®¹ç»„/çŸ­è¯­æ•°)
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=100
 æŒ‰é”®["height"]=25
 æŒ‰é”®["click"]=""
 æŒ‰é”®["label"]=çº¯è„šæœ¬å.."("..ç¼–å·.."/"..æ€»åºå·..")ã€é•¿æŒ‰ä¸Šå±ã€‘"
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®

if ç¼–å·==1 then
 if #æ˜¾ç¤ºå†…å®¹ç»„<çŸ­è¯­æ•° then
  for i=1,#æ˜¾ç¤ºå†…å®¹ç»„ do
    local æŒ‰é”®={}
    local ä½ç½®=i
    æŒ‰é”®["hint"]=æç¤ºå†…å®¹ç»„[ä½ç½®]
    æŒ‰é”®["long_click"]={label="", commit=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®]}
    æŒ‰é”®["click"]={label=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®], send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®].."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=é»˜è®¤å®½åº¦
  for i=1,çŸ­è¯­æ•°-#æ˜¾ç¤ºå†…å®¹ç»„ do
   æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--for
  local æŒ‰é”®={}
  local æŒ‰é”®=ä¸»é”®ç›˜()
  æŒ‰é”®["width"]=100
  æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 else
  
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®2
  for i=1,çŸ­è¯­æ•° do
   local å­ç¼–å·=i
   if #æ˜¾ç¤ºå†…å®¹ç»„>å­ç¼–å·-1 then
    local æŒ‰é”®={}
    local ä½ç½®=å­ç¼–å·
    æŒ‰é”®["hint"]=æç¤ºå†…å®¹ç»„[ä½ç½®]
    æŒ‰é”®["long_click"]={label="", commit=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®]}
    æŒ‰é”®["click"]={label=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®], send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®].."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
   end--if
  end--for
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=50
 æŒ‰é”®["click"]={label="ä¸‹ä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·+1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®=ä¸»é”®ç›˜()
 æŒ‰é”®["width"]=50
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®


 end--if #æ˜¾ç¤ºå†…å®¹ç»„<25
end--if ç¼–å·==1

if ç¼–å·>1 then
if #æ˜¾ç¤ºå†…å®¹ç»„<ç¼–å·*çŸ­è¯­æ•° then
  for i=1,#æ˜¾ç¤ºå†…å®¹ç»„-(ç¼–å·-1)*çŸ­è¯­æ•° do
    local æŒ‰é”®={}
    local ä½ç½®=i+(ç¼–å·-1)*çŸ­è¯­æ•°
    æŒ‰é”®["hint"]=æç¤ºå†…å®¹ç»„[ä½ç½®]
    æŒ‰é”®["long_click"]={label="", commit=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®]}
    æŒ‰é”®["click"]={label=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®], send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®].."ã€‘ã€‘<<"..ç¼–å·..">>"}
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--for
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=é»˜è®¤å®½åº¦
  for i=1,çŸ­è¯­æ•°*ç¼–å·-#æ˜¾ç¤ºå†…å®¹ç»„ do
   æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
  end--for
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=33
  æŒ‰é”®["click"]={label="ä¸Šä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·-1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®=ä¸»é”®ç›˜()
 æŒ‰é”®["width"]=34
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®

else
  for i=1,çŸ­è¯­æ•° do
   local å­ç¼–å·=i
   if #æ˜¾ç¤ºå†…å®¹ç»„>å­ç¼–å·-1 then
    local æŒ‰é”®={}
    local ä½ç½®=å­ç¼–å·+(ç¼–å·-1)*çŸ­è¯­æ•°
    æŒ‰é”®["hint"]=æç¤ºå†…å®¹ç»„[ä½ç½®]
    æŒ‰é”®["long_click"]={label="", commit=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®]}
    æŒ‰é”®["click"]={label=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®], send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®].."ã€‘ã€‘<<"..ç¼–å·..">>"}
    if æç¤ºå†…å®¹ç»„[ä½ç½®]=="å¥å­" then æŒ‰é”®["click"]={label=æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®], send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "ã€ã€"..æ˜¾ç¤ºå†…å®¹ç»„[ä½ç½®].."ã€‘ã€‘ã€Šã€Šç¿»è¯‘ã€‹ã€‹<<"..ç¼–å·..">>"} end
    æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
   end--if
  end--for
  local æŒ‰é”®={}
  æŒ‰é”®["width"]=33
 æŒ‰é”®["click"]={label="ä¸Šä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·-1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®={}
 æŒ‰é”®["width"]=33
 æŒ‰é”®["click"]={label="ä¸‹ä¸€é¡µ", send="function",command= è„šæœ¬ç›¸å¯¹è·¯å¾„,option= "<<"..(ç¼–å·+1)..">>"}
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
 local æŒ‰é”®=ä¸»é”®ç›˜()
 æŒ‰é”®["width"]=34
 æŒ‰é”®ç»„[#æŒ‰é”®ç»„+1]=æŒ‰é”®
end--if #æ˜¾ç¤ºå†…å®¹ç»„>ç¼–å·*22
end--if ç¼–å·>1 







service.setKeyboard{
  name=string.sub(çº¯è„šæœ¬å,1,#çº¯è„šæœ¬å-4),
  ascii_mode=0,
  width=é»˜è®¤å®½åº¦,
  height=é»˜è®¤é«˜åº¦,
  keys=æŒ‰é”®ç»„
  }









